# Critical Fixes - 2026-01-30

## Issues Fixed

### 1. ‚úÖ Image Reloading Performance Issue (Cookie Errors)
**Root Cause:** React components were remounting on every filter change, reloading all images and triggering thousands of Cloudflare cookie rejection errors.

**Files Changed:**
- [src/app/page.tsx](src/app/page.tsx#L332) - Changed key from `${family.id}-${searchTerm}-${classFilter}-${connectionsFilter}-${index}` to stable `family.id`
- [src/components/FamilyTableRow.tsx](src/components/FamilyTableRow.tsx) - Removed `unoptimized={true}` from 4 Image components
- [src/components/FamilyCard.tsx](src/components/FamilyCard.tsx) - Removed `unoptimized={true}` from 2 Image components

**Impact:** Eliminated constant image reloading on filter changes. Cookie errors should be gone.

---

### 2. ‚úÖ ETXTBSY File Locking Error
**Root Cause:** Two problems:
1. Dokploy running `next start` instead of `node server.js` (incompatible with standalone mode)
2. Next.js Image Optimization creating temp files with concurrent requests causing file locks

**Files Changed:**
- [next.config.ts](next.config.ts) - Added image optimization settings (7-day cache TTL, WebP format)
- [package.json](package.json#L8) - Changed `start` script from `next start` to `node server.js`
- [Dockerfile](Dockerfile#L34) - Added `/app/.next/cache/images` directory with proper permissions
- [docker-entrypoint.sh](docker-entrypoint.sh) - Added cleanup of stale cache and temp files on startup

**Impact:**
- Images are optimized once and cached for 7 days (reduces file operations)
- Proper standalone mode execution
- Cleanup of stale files on container restart

---

## üö® REQUIRED: Dokploy Configuration Changes

### Option A: Let Dokploy Use the Dockerfile (Recommended)

In your Dokploy dashboard:

1. **Build Settings:**
   - ‚úÖ Enable "Use Dockerfile"
   - Dockerfile path: `Dockerfile` (or `./Dockerfile`)

2. **Start Command:**
   - Leave EMPTY (uses Dockerfile CMD)
   - Or explicitly set to: `node server.js`

3. **Environment Variables:**
   ```env
   NODE_ENV=production
   NEXT_TELEMETRY_DISABLED=1
   ```

### Option B: Manual Start Command Override

If you must override the Dockerfile CMD:

**Start Command:**
```bash
node .next/standalone/server.js
```

**DO NOT USE:**
- ‚ùå `npm start` (now points to standalone but won't work if Dokploy overrides)
- ‚ùå `next start` (incompatible with standalone mode)

---

## Verification Steps

After deploying these changes:

### 1. Check Start Command
In your Dokploy logs, you should see:
```
‚úì Ready in ~1000ms
```

You should NOT see:
```
‚ö† "next start" does not work with "output: standalone"
```

### 2. Check for ETXTBSY Errors
Search logs for "ETXTBSY". Should be ZERO occurrences after these changes.

### 3. Monitor Resource Usage
After 15-20 minutes of operation:
- **Memory:** Should stay under 1GB
- **CPU:** Should be 20-40% typical
- **I/O:** Should be low (images cached, no constant reloading)

### 4. Check Browser Console
- Cookie errors should be gone
- Images should load once and stay cached

---

## What Each Fix Does

### Image Optimization Caching
```typescript
minimumCacheTTL: 60 * 60 * 24 * 7, // 7 days
```
- First request: Next.js downloads from Supabase, optimizes with Sharp, caches result
- Subsequent requests: Serves from cache (no file operations)
- After 7 days: Re-optimizes if needed

### Stable React Keys
```tsx
key={family.id} // Instead of dynamic key
```
- Components stay mounted when filters change
- Images don't reload unnecessarily
- No Cloudflare cookie spam

### Standalone Mode
```bash
node server.js
```
- Runs optimized production server
- No build-time dependencies needed
- Faster startup, lower memory

---

## Expected Performance Improvements

| Metric | Before | After |
|--------|--------|-------|
| Cookie errors | Thousands | Zero |
| Image reloads on filter | All images | None |
| ETXTBSY errors | Frequent | Zero |
| Image optimization | Every request | Once per 7 days |
| Memory after 15 min | 3-5 GB | 500MB-1GB |
| CPU usage | 100%+ | 20-40% |

---

## Rollback Plan

If issues occur:

```bash
# Revert to previous commit
git revert HEAD
git push

# Or manually revert specific files
git checkout HEAD~1 next.config.ts package.json Dockerfile docker-entrypoint.sh
```

Then in Dokploy:
1. Change start command back to `npm run start:dev` (we kept this for rollback)
2. Redeploy

---

## Next Steps (Optional Optimizations)

These are **not required** for fixing the current issues, but recommended for scalability:

1. **Pagination** - Load families in batches of 50 instead of all at once
2. **React Query** - Better caching and data synchronization
3. **CDN** - Put a CDN in front of Supabase images
4. **Lazy Load Images** - Already enabled via Next.js Image component
5. **Database Indexes** - Ensure indexes exist on family_id columns

---

## Support

If you see continued issues:

1. **Check Dokploy logs** for the actual start command being used
2. **Verify** `output: 'standalone'` is in next.config.ts
3. **Confirm** `.next/standalone/server.js` exists after build
4. **Test locally** with: `npm run build && npm start`
